import requests
import hashlib
import json
from tkinter import filedialog

# VirusTotal API v2 related information
url_scan_v2 = "https://www.virustotal.com/vtapi/v2/file/scan"
url_report_v2 = "https://www.virustotal.com/vtapi/v2/file/report"
api_key_v2 = "Private"

# VirusTotal API v3 related information
url_scan_v3 = "https://www.virustotal.com/api/v3/files"
url_analysis_v3 = "https://www.virustotal.com/api/v3/analyses"
api_key_v3 = "Private"

def upload_file_to_virustotal_v2(file_path):
    try:
        # File upload
        files = {"file": (file_path, open(file_path, "rb"))}
        params = {"apikey": api_key_v2}
        response_scan = requests.post(url_scan_v2, files=files, params=params)
        
        if response_scan.status_code == 200:
            json_response = response_scan.json()
            resource = json_response["resource"]
            return resource
        else:
            print("File upload failed:", response_scan.text)
            return None
    except Exception as e:
        print("File upload error:", e)
        return None

def get_file_report_from_virustotal_v2(resource):
    try:
        # File report request
        params = {"apikey": api_key_v2, "resource": resource}
        response_report = requests.get(url_report_v2, params=params)

        if response_report.status_code == 200:
            json_response = response_report.json()
            return json_response
        else:
            print("File report request failed:", response_report.text)
            return None
    except Exception as e:
        print("File report request error:", e)
        return None

def upload_file_to_virustotal_v3(file_path):
    try:
        # File upload
        with open(file_path, "rb") as f:
            file_data = f.read()

        # File hash (MD5) calculation
        md5_hash = hashlib.md5(file_data).hexdigest()

        # File upload request to VirusTotal API v3
        headers = {"x-apikey": api_key_v3}
        files = {"file": (file_path, file_data)}
        response = requests.post(url_scan_v3, headers=headers, files=files)

        if response.status_code == 200:
            data = response.json()
            file_id = data["data"]["id"]

            # File report retrieval
            report_url = f"{url_analysis_v3}/{file_id}"
            response = requests.get(report_url, headers=headers)

            if response.status_code == 200:
                analysis_data = response.json()
                attributes = analysis_data["data"]["attributes"]["stats"]
                return attributes
            else:
                return None
        else:
            return None
    except Exception as e:
        print("File upload error:", e)
        return None

def print_file_report(report):
    if report is not None:
        print("File scan result:")
        print(json.dumps(report, indent=4))
    else:
        print("Report not found.")

if __name__ == "__main__":
    # File selection dialog to choose a file
    selected_file = filedialog.askopenfilename()

    if selected_file:
        # File upload and report retrieval using VirusTotal API v2
        resource_v2 = upload_file_to_virustotal_v2(selected_file)
        if resource_v2:
            report_v2 = get_file_report_from_virustotal_v2(resource_v2)
            if report_v2:
                print_file_report(report_v2)
            else:
                print("Unable to fetch file report.")
        else:
            print("Failed to upload file using VirusTotal API v2")

        # File upload and report retrieval using VirusTotal API v3
        report_v3 = upload_file_to_virustotal_v3(selected_file)
        if report_v3:
            print_file_report(report_v3)
        else:
            print("Failed to upload file and fetch report using VirusTotal API v3")
    else:
        print("No file selected.")
